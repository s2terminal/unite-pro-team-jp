---
import Layout from '../../layouts/Layout.astro';
import Meta from '../../components/Meta.astro';
import {
  getAllPlayerSlugs,
  getPlayerBySlug,
  getPlayerHistory,
  getCurrentTeamForPlayer,
  getTeams,
} from '../../lib/models';
import PlayerDetail from '../../components/pages/PlayerDetail';

export async function getStaticPaths() {
  const slugs = await getAllPlayerSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const player = await getPlayerBySlug(slug!);
const teams = await getTeams();
const teamBySlug = new Map(teams.map((t) => [t.slug, t]));
const currentTeamSlug = await getCurrentTeamForPlayer(slug!);
const history = await getPlayerHistory(slug!);
---

<Layout>
  <Fragment slot="head">
    <Meta
      title={player?.name ? `${player.name} | 選手情報` : `選手情報 (${slug})`}
      type="profile"
    />
  </Fragment>
  <PlayerDetail
    client:visible
    player={player ?? { slug, name: slug }}
    currentTeam={currentTeamSlug}
    history={history}
    teamBySlug={Object.fromEntries(teamBySlug)}
  />
</Layout>
